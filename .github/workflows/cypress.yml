name: E2E on Chrome
on: [push]
#  push:
#    branches:
#      - alpha
#      - beta
#      - stable
#      - mrbeam2-beta
#      - mrbeam2-stable
jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: E2E on Chrome
    steps:
      - uses: actions/checkout@v3
      - uses: actions/cache@v3  # Cache dependencies to speed up process
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - uses: cypress-io/github-action@v4
        with:
          start: npm run docker:build-and-run
          wait-on: "http://localhost:5002/"
          wait-on-timeout: 360
          browser: chrome
          config-file: cypress.config.js
        env:
          # pass GitHub token to detect new build vs re-run build
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: Merge reports
        if: always()
        run: npm run merge-reports
      - name: Submit results to Xray
        env:
          JIRA_SERVER_URL: ${{ secrets.jira_server_url }}
          JIRA_USERNAME: ${{ secrets.jira_username }}
          JIRA_PASSWORD: ${{ secrets.jira_password }}
        run: 'curl -H "Content-Type: multipart/form-data" -u $JIRA_USERNAME:$JIRA_PASSWORD -F "file=@cypress/results/combined.xml" "$JIRA_SERVER_URL/rest/raven/1.0/import/execution/junit?projectKey=CALC"'


